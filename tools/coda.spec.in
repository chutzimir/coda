
Summary: Coda distributed filesystem
Name: @CODA@
Version: @CVER@
Release: @REL@
Source: ftp://ftp.coda.cs.cmu.edu/pub/coda-src/coda-@CVER@.tgz
Source1: venus.init
Requires: bc
Copyright: CMU
BuildRoot: /usr/src/redhat/BUILD/coda-build
Group: Networking/Daemons
%description
Source package for the Coda filesystem.  Three packages are provided by
this rpm: the client and server components, and documentation.  A
kernel module for 2.0.x  kernels which have MODVERSIONS enabled is
included in the client module. 


%package source
Summary: Coda sources
Group: Networking/Daemons
%description source
This contains the coda sources used for building the rpm (in the same
location as during the build).  Install this if you want to run gdb on
the Coda binaries.

%package client-@LIBC@
Summary: Coda client
Group: Networking/Daemons
%description client-@LIBC@
Also included are the binaries for the cachemanager, venus, the cfs
utilities for logging, ACL manipulation etc, the hoarding tools for
use with laptops and repair tools for fixing conflicts. Finally there
is the cmon and codacon console utilities to monitor coda's
activities. You need the coda kernel-module for your kernel version to 
have a complete coda client.  Make sure to select the correct C library
version. 

%package kernel-@KVER@-module
Summary: Coda kernel module
Group: Networking/Daemons
%description kernel-@KVER@-module
This package provides the kernel module with the coda-filesystem and the
coda pseudo device. You need this on a client only and use it in conjunction
with the user level cache manager in the coda-client package. 


%package server-@LIBC@
Summary: Coda server
Group: Networking/Daemons
%description server-@LIBC@
This package contains the fileserver for the coda filesystem, as well as
the volume utilities.  For highest performance you will need a modified
kernel with inode system calls.

%package backup-@LIBC@
Summary: Coda backup coordinator
Group: Networking/Daemons
%description backup-@LIBC@
This package contains the backup software for the coda filesystem, as
well as the volume utilities.

%changelog
* Tue Dec 30 1997 Peter Braam <braam@cs.cmu.edu>
- several changes: documentation separate
- use variables: @KVER@=`uname -r`, @CVER@=coda version
* Mon Jun 02 1997 Peter Braam <braam@cs.cmu.edu>
- small changes to Elliots improvements.
- some of his ideas are now in the scripts
* Wed May 28 1997 Elliot Lee <sopwith@redhat.com>
- Based upon 4.0.3-1 spec file.
- Changed to BuildRoot
- Do as much as possible at build time instead of in %post
- Added initscript for venus
	
%prep
%setup -n coda-@CVER@

%build
chown -R root.bin $RPM_BUILD_DIR/coda-@CVER@
rm -rf $RPM_BUILD_DIR/obj-@CVER@
mkdir $RPM_BUILD_DIR/obj-@CVER@
cd $RPM_BUILD_DIR/obj-@CVER@
../coda-@CVER@/configure --prefix=$RPM_BUILD_ROOT/usr
make GFLAG="" coda

%install
cd $RPM_BUILD_DIR/obj-@CVER@
rm -rf $RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT/usr/coda/venus.cache $RPM_BUILD_ROOT/dev \
	$RPM_BUILD_ROOT/usr/coda/etc $RPM_BUILD_ROOT/lib/modules/@KVER@/fs \
	$RPM_BUILD_ROOT/coda $RPM_BUILD_ROOT/etc/rc.d/init.d\
	$RPM_BUILD_ROOT/usr/man $RPM_BUILD_ROOT/$RPM_BUILD_DIR\
	$RPM_BUILD_ROOT/usr/lib/coda $RPM_BUILD_ROOT/etc/rc.d/init.d

# make prefix=$RPM_BUILD_ROOT/usr man-install

make GFLAG="" client-install
make GFLAG=""  server-install


install -m755 $RPM_SOURCE_DIR/venus.init \
	$RPM_BUILD_ROOT/etc/rc.d/init.d/venus.init


# cp kernel-src/vfs/linux@KV@/coda.o $RPM_BUILD_ROOT/lib/modules/@KVER@/fs/coda.o

touch $RPM_BUILD_ROOT/usr/coda/etc/vstab
touch $RPM_BUILD_ROOT/usr/coda/venus.cache/INIT
mknod $RPM_BUILD_ROOT/dev/cfs0 c 67 0
touch $RPM_BUILD_ROOT/coda/NOT_REALLY_CODA


# for non debuging versions
if [ X@DEBUG@ != X1 ]; then
   strip $RPM_BUILD_ROOT/usr/bin/* $RPM_BUILD_ROOT/vice/bin/* $RPM_BUILD_ROOT/usr/sbin/* || :
fi

cd $RPM_BUILD_DIR
cp $RPM_SOURCE_DIR/coda-@CVER@.tgz $RPM_BUILD_ROOT/$RPM_BUILD_DIR/coda-@CVER@.tgz
chown -R root.root $RPM_BUILD_ROOT

%clean
rm -rf $RPM_BUILD_ROOT

%pre client-@LIBC@
grep /coda /proc/mounts > /dev/null 2>1
if [ $? = 0 ]; then
	echo "*** Coda is mounted: cannot install ***"
	exit 1
else
	exit 0
fi

%preun client-@LIBC@
grep /coda /proc/mounts > /dev/null 2>1
if [ $? = 0 ]; then
	echo "*** Coda is mounted: cannot install ***"
	exit 1
else
	exit 0
fi

	
%post client-@LIBC@
if [ -e /usr/coda/etc/vstab ]; then 
	touch /usr/coda/venus.cache/INIT
else
	/usr/sbin/venus-setup testserver.coda.cs.cmu.edu
fi
cd /usr/lib/coda
tixindex *tcl

%post source
cd /usr/src/redhat/BUILD
tar zxf coda-@CVER@.tgz

%post kernel-@KVER@-module
/sbin/depmod -a 

%files kernel-@KVER@-module
/dev/cfs0
/lib/modules/@KVER@/fs/coda.o

%files source
%dir /usr/src/redhat/BUILD/coda-@CVER@.tgz

%files client-@LIBC@
%dir /usr/coda
%dir /usr/coda/etc
%dir /usr/coda/venus.cache
%verify() /usr/coda/venus.cache/INIT
/etc/rc.d/init.d/venus.init
%dir /coda
%verify() /coda/NOT_REALLY_CODA
/usr/sbin/venus-setup
/usr/sbin/vutil
/usr/sbin/venus
/usr/sbin/au
/usr/sbin/coda-debug
/usr/sbin/coda-trace
/usr/bin/advice_srv
/usr/bin/filcon
/usr/bin/clog
/usr/bin/cpasswd
/usr/bin/ctokens
/usr/bin/cunlog
/usr/bin/repair
/usr/bin/cmon
/usr/bin/codacon
/usr/bin/cfs
/usr/bin/hoard
/usr/bin/spy
/usr/bin/replay
/usr/bin/parser
/usr/bin/filerepair
/usr/bin/removeinc
/usr/bin/xfrepair
/usr/bin/xaskuser
/usr/sbin/volmunge
/usr/lib/coda/Advice.tcl            
/usr/lib/coda/Consider.tcl          
/usr/lib/coda/ConsiderAdding.tcl    
/usr/lib/coda/ConsiderRemoving.tcl  
/usr/lib/coda/ControlPanel.tcl      
/usr/lib/coda/Date.tcl              
/usr/lib/coda/DiscoMiss.tcl         
/usr/lib/coda/Events.tcl            
/usr/lib/coda/Helper.tcl            
/usr/lib/coda/HoardWalk.tcl         
/usr/lib/coda/HoardWalkAdvice.tcl   
/usr/lib/coda/Indicators.tcl        
/usr/lib/coda/Initialization.tcl    
/usr/lib/coda/Lock.tcl              
/usr/lib/coda/Log.tcl               
/usr/lib/coda/Network.tcl           
/usr/lib/coda/OutsideWorld.tcl      
/usr/lib/coda/ReadMiss.tcl          
/usr/lib/coda/Reconnection.tcl      
/usr/lib/coda/Reintegration.tcl     
/usr/lib/coda/Repair.tcl            
/usr/lib/coda/Space.tcl             
/usr/lib/coda/Task.tcl              
/usr/lib/coda/Timing.tcl            
/usr/lib/coda/Tokens.tcl            
/usr/lib/coda/WeakMiss.tcl          
/usr/lib/coda/tixCodaMeter.tcl      
/usr/lib/coda/CodaConsole
/usr/lib/coda/Globals.tcl

%files server-@LIBC@	
/usr/sbin/rvmutl
/usr/sbin/rdsinit
/usr/sbin/startserver
/usr/sbin/partial-reinit.sh
/usr/sbin/reinit.sh
/usr/sbin/recreatevol
/usr/sbin/recreatevol_rep
/usr/sbin/createvol
/usr/sbin/createvol_rep
/usr/sbin/purgevol
/usr/sbin/purgevol_rep
/usr/sbin/bldvldb.sh
/usr/sbin/vice-setup
/usr/sbin/vice-setup-rvm
/usr/sbin/vice-setup-srvdir
/usr/sbin/vice-setup-user
/usr/sbin/vice-setup-scm
/usr/sbin/vice-killvolumes
/usr/sbin/vice-install
/usr/sbin/pcfgen
/usr/sbin/pwd2pdb
/usr/sbin/mvdb
/usr/sbin/auth2
/usr/sbin/authmon
/usr/sbin/initpw
/usr/sbin/volutil
/usr/sbin/makeftree
/usr/sbin/inoder
/usr/sbin/parserecdump
/usr/sbin/srv
/usr/sbin/printvrdb
/usr/sbin/updatemon
/usr/sbin/updatesrv
/usr/sbin/updateclnt
/usr/sbin/updatefetch
/usr/bin/filcon
/usr/bin/norton
/usr/bin/norton-reinit
/usr/bin/reinit
/etc/rc.d/init.d/vice.init

%files backup-@LIBC@	
/usr/sbin/backup.sh
/usr/sbin/tape.pl
/usr/sbin/auth2
/usr/sbin/authmon
/usr/sbin/volutil
/usr/sbin/backup
/usr/sbin/readdump
/usr/sbin/merge
/usr/sbin/updatemon
/usr/sbin/updatesrv
/usr/sbin/updateclnt
/usr/sbin/updatefetch
/usr/bin/filcon
