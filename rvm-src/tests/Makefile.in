#ifndef _BLURB_
#define _BLURB_
#
#
#     RVM: an Experimental Recoverable Virtual Memory Package
#			Release 1.3
#
#       Copyright (c) 1990-1994 Carnegie Mellon University
#                      All Rights Reserved.
#
# Permission  to use, copy, modify and distribute this software and
# its documentation is hereby granted (including for commercial  or
# for-profit use), provided that both the copyright notice and this
# permission  notice  appear  in  all  copies  of   the   software,
# derivative  works or modified versions, and any portions thereof,
# and that both notices appear  in  supporting  documentation,  and
# that  credit  is  given  to  Carnegie  Mellon  University  in all
# publications reporting on direct or indirect use of this code  or
# its derivatives.
#
# RVM  IS  AN  EXPERIMENTAL  SOFTWARE  PACKAGE AND IS KNOWN TO HAVE
# BUGS, SOME OF WHICH MAY  HAVE  SERIOUS  CONSEQUENCES.    CARNEGIE
# MELLON ALLOWS FREE USE OF THIS SOFTWARE IN ITS "AS IS" CONDITION.
# CARNEGIE MELLON DISCLAIMS ANY  LIABILITY  OF  ANY  KIND  FOR  ANY
# DAMAGES  WHATSOEVER RESULTING DIRECTLY OR INDIRECTLY FROM THE USE
# OF THIS SOFTWARE OR OF ANY DERIVATIVE WORK.
#
# Carnegie Mellon encourages (but does not require) users  of  this
# software to return any improvements or extensions that they make,
# and to grant Carnegie Mellon the  rights  to  redistribute  these
# changes  without  encumbrance.   Such improvements and extensions
# should be returned to Software.Distribution@cs.cmu.edu.
#
# rcsid = $Header$
#
#endif _BLURB_

#   	RVM Test Programs Makefile

# get basic definitions
# include ..$(ROOT)/build_defs

TOPDIR = @top_srcdir@
srcdir = @srcdir@
VPATH = @srcdir@

# Need to conditionalize this
include $(TOPDIR)/Makeconf

EXECUTABLES = testrvm rvm_basher

RVMDIR = ${ROOT}/src/rvm
SEGDIR = ${ROOT}/src/seg
RDSDIR = ${ROOT}/src/rds
RVMOBJDIR = ${ROOT}/obj/rvm
SEGOBJDIR = ${ROOT}/obj/seg
RDSOBJDIR = ${ROOT}/obj/rds
PLUMBLIB  = /coda/project/coda/alpha/LIB-SPECIAL
LWPLIB    = ${ROOT}/LWPROOT/lib
LIBFLAGS  = ${LIBFLAGS} ${LIBCOMPAT}
cc = ${CC}
# CFLAGS = -g3 -O2 -I/afs/cs.cmu.edu/user/tilt/rvm-top/include

# tests definitions
HFILES = $(RVMDIR)/rvm.h $(RVMDIR)/rvm_statistics.h \
    	    $(RDSDIR)/rds.h $(SEGDIR)/rvm_segment.h

# build simple RVM test program
testrvm.o: $(HFILES) testrvm.h testrvm.c
	$(cc) -c $(CFLAGS) testrvm.c

testrvm: $(HFILES) testrvm.h testrvm.o $(RVMOBJDIR)/librvm.a
	$(cc) $(CFLAGS) -o testrvm testrvm.o \
	    $(RVMOBJDIR)/librvm.a $(LIBFLAGS)

# build better test program using seg and rds
rvm_basher.o:	rvm_basher.c $(HFILES)
	$(cc) -c $(CFLAGS) -I$(RDSDIR)/rds.h -I$(SEGDIR)/rvm_segment.h \
    	    rvm_basher.c

rvm_basher: rvm_basher.o $(HFILES) $(RVMOBJDIR)/librvm.a \
    	    $(RDSOBJDIR)/librds.a $(SEGOBJDIR)/libseg.a
	$(cc) $(CFLAGS) -o rvm_basher rvm_basher.o $(RDSOBJDIR)/librds.a \
    	    $(SEGOBJDIR)/libseg.a $(RVMOBJDIR)/librvm.a $(LIBFLAGS)

#clean:  
#	-rm *.o testrvm rvm_basher lwp_basher

installfiles:
	$(INSTALL) testrvm $(BINDIR)
	-chmod 0755 $(BINDIR)/testrvm
	$(INSTALL) rvm_basher $(BINDIR)
	-chmod 0755 $(BINDIR)/rvm_basher

install:
	make clean
	make reinstall

reinstall:
	make all
	make installfiles

all:  testrvm rvm_basher


# Coda-specific installations

lwp_basher.o:	rvm_basher.c $(HFILES) $(RVMDIR)/rvm_lwp.h
	-mv rvm_basher.o xxx_basher.o
	make CFLAGS="$(CFLAGS) -DRVM_USELWP" rvm_basher.o
	mv rvm_basher.o lwp_basher.o
	-mv xxx_basher.o rvm_basher.o

lwp_basher: lwp_basher.o $(HFILES) $(RVMOBJDIR)/librvmlwp.a \
    	    $(RDSOBJDIR)/librdslwp.a $(SEGOBJDIR)/libseg.a
	$(cc) $(CFLAGS) -o lwp_basher lwp_basher.o $(RDSOBJDIR)/librdslwp.a \
    	    $(SEGOBJDIR)/libseg.a $(RVMOBJDIR)/librvmlwp.a \
    	    $(PLUMBLIB)/libplumber.a $(LWPLIB)/liboldlwp.a -lmach

installlwpfiles:
	$(INSTALL) lwp_basher $(BINDIR)
	-chmod 0755 $(BINDIR)/lwp_basher

reinstalllwp:
	make lwp_basher
	make installlwpfiles

installlwp:
	-rm lwp_basher lwp_basher.o
	make reinstalllwp

lwp:	lwp_basher
