#
#
# BLURB lgpl
# 
#                            Coda File System
#                               Release 5
# 
#           Copyright (c) 1987-1999 Carnegie Mellon University
#                   Additional copyrights listed below
# 
# This  code  is  distributed "AS IS" without warranty of any kind under
# the  terms of the  GNU  Library General Public Licence  Version 2,  as
# shown in the file LICENSE. The technical and financial contributors to
# Coda are listed in the file CREDITS.
# 
#                         Additional copyrights
#                            none currently
# 
#*/
TOPDIR = @top_srcdir@

srcdir = @srcdir@
VPATH  = @srcdir@
TOPOBJ = @TOPOBJ@

include $(TOPDIR)/Makeconf

# BSD platforms need libcompat.a for insque and deque
RVMUTL_LIBS = ${LIBTHREADS} ${LIBBASE} $(LIBS)

EXPHEADERS  = rvm.h rvm_statistics.h rvm_lwp.h rvm_private.h \
              rvm_pthread.h
PRIVHEADERS = dummy_cthreads.h

LIBOBJ = rvm_init.o rvm_map.o rvm_unmap.o rvm_trans.o rvm_logstatus.o \
       rvm_logflush.o rvm_logrecovr.o rvm_utils.o rvm_io.o rvm_status.o \
       rvm_debug.o rvm_printers.o

OBJ = rvmutl.o

# Note: to build librvmlwp.a with debugging for the log tail bug,
# Use one of the two commented out targets instead.
#       RVM_LOG_TAIL_BUG uses page protection
#       -DRVM_LOG_TAIL_BUG
#       RVM_LOG_TAIL_SHADOW uses shadow variables
#       -DRVM_LOG_TAIL_SHADOW

#
# RVM can be built in 4 ways:
#  - cthreads
#               libs: must use libthreads.a and libmach.a
#               flags: 
#  - no threads (used by standalone rvm utilities in Coda
#		flags: none
#		libs: none
#                 library produced:  librvm.a
#  - lwp theads (used in Coda)
#		flags: -DRVM_USELWP
#		libs: 
#		library produced: librvmlwp.a
#  - pthreads

HEADERS     := ${EXPHEADERS} ${PRIVHEADERS}
LIBRARIES   := librvm.a
EXECUTABLES := rvmutl
SSBINS      := rvmutl
librvm.a: $(LIBOBJ)
rvmutl:  librvm.a ${OBJ}
	$(CC) $(LIBFLAGS) ${OBJ} librvm.a ${RVMUTL_LIBS} -o $@

# and build the lwp version of librvm here as well
LIBRARIES  += librvmlwp.a
LWPLIBOBJ  := $(LIBOBJ:.o=_lwp.o)

librvmlwp.a: $(LWPLIBOBJ)

%_lwp.o : %.c
	$(CC) $(CFLAGS) -DRVM_USELWP -c $< -o $@


ifeq ($(RVMTARGET),cthreads)
CFLAGS += ....
LIBS += -lmach -lthreads
librvm.a:  $(NEED_CTHREAD) $(LIBOBJ)
endif

ifeq ($(RVMTARGET),pthreads)
LIBOBJ += rvm_pthread.o
librvmpt.a: $(LIBOBJ)
endif

include $(TOPDIR)/configs/Makerules
