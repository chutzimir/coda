# 
# BLURB gpl
# 
#                            Coda File System
#                               Release 5
# 
#           Copyright (c) 1987-1999 Carnegie Mellon University
#                   Additional copyrights listed below
# 
# This  code  is  distributed "AS IS" without warranty of any kind under
# the terms of the GNU General Public Licence Version 2, as shown in the
# file  LICENSE.  The  technical and financial  contributors to Coda are
# listed in the file CREDITS.
# 
#                         Additional copyrights
#                            none currently
# 
#*/

TOPDIR = @top_srcdir@

srcdir = @srcdir@
VPATH  = @srcdir@
TOPOBJ = @TOPOBJ@

include $(TOPDIR)/Makeconf

#
# Kerberos stuff
#

ifeq ($(KERBEROS),)
CLOG=clog
AUTH2=auth2
AU=au
LIBAUTH2OBJS=auth2.server.o acommon.o avice.o pwsupport.o
LIBAUSEROBJS=auth2.client.o acommon.o auser.o avenus.o
LIBKRBS=
else
CLOG=kclog
AUTH2=kauth2
AU=kau
LIBAUTH2OBJS=auth2.server.o acommon.o avice.o pwsupport.o krbsupport.o
LIBAUSEROBJS=auth2.client.o acommon.o auser.o avenus.o krbsupport.o
CFLAGS += $(KRBINCLFLAGS)
endif

ifneq ($(KERBEROS5),)
CFLAGS += -DKERBEROS5
endif

ifneq ($(KERBEROS4),)
CFLAGS += -DKERBEROS4
endif

CFLAGS += -DCODAAUTH


#
# non- Dos stuff
#

ifeq ($(SHORTSYS),djgpp)
EXECUTABLES = $(CLOG)
else
EXECUTABLES = $(CLOG) $(AUTH2) initpw $(AU) cpasswd ctokens cunlog tokentool
CBINS       = $(CLOG) cpasswd ctokens cunlog

CSBINS      = $(AU)
SBINS       = 
SSBINS      = $(AU) $(AUTH2) initpw
endif

CFLAGS := -Wall $(CFLAGS)

RP2HEADERS  = auth2.h

LIBS :=	${LIBRPC2}\
	${LIBAL}\
	${LIBOLDLWP}\
	${LIBUTIL} \
	${LIBKERNDEP} \
	${LIBAUSER}\
	${LIBCOMPAT}\
	${LIBBASE}

ifeq ($(SYS),sol2)
LIBFIXUP += -R/usr/ucblib -L/usr/ucblib -lucb
endif

LIBRARIES   = libauth2.a libauser.a
HEADERS     = avenus.h
OBJS = auth2.client.o auth2.server.o auth2.multi.o au.o auser.o avenus.o avice.o initpw.o

include $(TOPDIR)/configs/Makerules

libauth2.a: $(LIBAUTH2OBJS)

libauser.a: $(LIBAUSEROBJS)

$(AUTH2): auth2.o libauth2.a $(LIBS)
	$(CC) $(LDFLAGS) auth2.o libauth2.a $(LIBS) $(LIBKRBS) $(LIBDB) $(LIBFIXUP) -o $(AUTH2)

initpw: initpw.o $(LIBS)
	$(CC) $(LDFLAGS) initpw.o $(LIBS) $(LIBFIXUP) -o initpw

$(AU): au.o libauser.a $(LIBS)
	$(CC) $(LDFLAGS) au.o libauser.a $(LIBS) $(LIBKRBS) $(LIBFIXUP) -o $(AU)

$(CLOG): clog.o tokenfile.o libauser.a ${LIBS}
	${CC} $(LDFLAGS) clog.o tokenfile.o libauser.a ${LIBS} $(LIBKRBS) $(LIBFIXUP) -o $(CLOG)

cunlog: cunlog.o libauser.a ${LIBS}
	${CC} $(LDFLAGS) cunlog.o libauser.a ${LIBS} $(LIBFIXUP) -o cunlog

cpasswd: cpasswd.o libauser.a ${LIBS}
	${CC} $(LDFLAGS) cpasswd.o  libauser.a ${LIBS} ${LIBKRBS} $(LIBFIXUP) -o cpasswd

ctokens: ctokens.o libauser.a ${LIBS}
	${CC} $(LDFLAGS) ctokens.o libauser.a ${LIBS} $(LIBFIXUP) -o ctokens

tokentool: tokentool.o tokenfile.o ${LIBS}
	${CC} $(LDFLAGS) tokentool.o tokenfile.o ${LIBS} $(LIBFIXUP) -o tokentool
