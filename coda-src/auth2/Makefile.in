# 
# BLURB gpl
# 
#                            Coda File System
#                               Release 6
# 
#           Copyright (c) 1987-2003 Carnegie Mellon University
#                   Additional copyrights listed below
# 
# This  code  is  distributed "AS IS" without warranty of any kind under
# the terms of the GNU General Public Licence Version 2, as shown in the
# file  LICENSE.  The  technical and financial  contributors to Coda are
# listed in the file CREDITS.
# 
#                         Additional copyrights
#                            none currently
# 
#*/

TOPDIR = @top_srcdir@

srcdir = @srcdir@
VPATH  = @srcdir@
TOPOBJ = @TOPOBJ@

include $(TOPDIR)/Makeconf

CFLAGS += -DCODAAUTH

AUTHCOMMON := acommon.o
LIBKRBS=

ifneq ($(LIBKRB4),)
AUTHCOMMON += krb4.o
LIBKRBS += $(LIBKRB4)
endif

ifneq ($(LIBKRB5),)
AUTHCOMMON += krb5.o
LIBKRBS += $(LIBKRB5)
endif

ifneq ($(LIBKRB4)$(LIBKRB5),)
AUTHCOMMON += krbcommon.o
endif

LIBAUTH2OBJS=auth2.server.o avice.o pwsupport.o $(AUTHCOMMON)
LIBAUSEROBJS=auth2.client.o auser.o avenus.o $(AUTHCOMMON)

CBINS       = clog cpasswd ctokens cunlog au
CMANPAGES   = au.1 clog.1 cpasswd.1 ctokens.1 cunlog.1
SSBINS      = auth2 initpw
SMANPAGES   = auth2.8 initpw.8 passwd.coda.5
EXECUTABLES = $(CBINS) $(SSBINS) tokentool

#
# only build clog on win9x
#
ifeq ($(SHORTSYS),djgpp)
EXECUTABLES = clog
endif

RP2HEADERS  = auth2.h

DEPLIBS = $(LIBUTIL) $(LIBKERNDEP) $(LIBBASE)
LIBS := $(LIBRPC2) $(LIBLWP) $(LIBCRYPTO) $(LIBS)

LIBRARIES   = libauth2.a libauser.a
HEADERS     = avenus.h avice.h
OBJS = auth2.client.o auth2.server.o auth2.multi.o au.o auser.o avenus.o avice.o initpw.o

include $(TOPDIR)/configs/Makerules

libauth2.a: $(LIBAUTH2OBJS)

libauser.a: $(LIBAUSEROBJS)

auth2: auth2.o libauth2.a $(LIBAL) $(LIBRWCDB) $(DEPLIBS)
	${CC} $(LDFLAGS) $^ ${LIBKRBS} ${LIBS} -o $@

au: au.o libauser.a $(DEPLIBS)
	${CC} $(LDFLAGS) $^ ${LIBKRBS} ${LIBS} -o $@

clog: clog.o tokenfile.o libauser.a ${DEPLIBS}
	${CC} $(LDFLAGS) $^ ${LIBKRBS} ${LIBS} -o $@

cpasswd: cpasswd.o libauser.a ${DEPLIBS}
	${CC} $(LDFLAGS) $^ ${LIBKRBS} ${LIBS} -o $@

initpw: initpw.o $(DEPLIBS)
	${CC} $(LDFLAGS) $^ ${LIBS} -o $@

cunlog: cunlog.o libauser.a ${DEPLIBS}
	${CC} $(LDFLAGS) $^ ${LIBS} -o $@

ctokens: ctokens.o libauser.a ${DEPLIBS}
	${CC} $(LDFLAGS) $^ ${LIBS} -o $@

tokentool: tokentool.o tokenfile.o ${DEPLIBS}
	${CC} $(LDFLAGS) $^ ${LIBS} -o $@

